<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MATI - Tu Coach Matem√°tico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      /* Paleta de colores "Cyber Math" */
      --bg-color: #0f172a;
      --chat-bg: #1e293b;
      --accent-primary: #8b5cf6; /* Violeta vibrante */
      --accent-secondary: #06b6d4; /* Cian el√©ctrico */
      --text-white: #f8fafc;
      --text-gray: #94a3b8;
      --user-bubble: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --bot-bubble: #1e293b;
    }

    body {
      margin: 0;
      font-family: 'Nunito', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-color);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 20%);
      color: var(--text-white);
      min-height: 100dvh;
      overflow: hidden; /* Evita scroll en el body, solo en el chat */
    }

    * { box-sizing: border-box; }

    /* Contenedor principal estilo App */
    .app-shell {
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100dvh;
      min-height: 0;
      width: 100%;
      margin: 0 auto;
      background: rgba(30, 41, 59, 0.5); /* Efecto cristal */
      backdrop-filter: blur(10px);
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    /* Cabecera */
    .top-bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(15, 23, 42, 0.9);
      z-index: 10;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-image {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.1);
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 0 15px var(--accent-primary);
      object-fit: contain;
    }

    .app-title {
      font-family: 'Nunito', system-ui, -apple-system, sans-serif;
      font-size: 21px;
      font-weight: 600;
      background: linear-gradient(to right, #c084fc, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .reset-btn {
      justify-self: end;
      background: transparent;
      color: var(--text-gray);
      border: 1px solid rgba(148, 163, 184, 0.5);
      border-radius: 999px;
      padding: 8px 14px;
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .reset-btn:hover {
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-white);
      background: rgba(148, 163, 184, 0.1);
    }

    /* √Årea del Chat */
    .chat-area {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
      scroll-behavior: smooth;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .streak-bar {
      display: flex;
      align-items: center;
      font-weight: 700;
      color: var(--text-white);
      gap: 10px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    /* Mensajes */
    .message-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      opacity: 0;
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes popIn {
      from { opacity: 0; transform: translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-row.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .avatar.bot { background: var(--accent-secondary); box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }
    .avatar.user { background: var(--accent-primary); }
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .bubble {
      max-width: 80%;
      padding: 16px 18px;
      border-radius: 20px;
      font-size: 18px;
      line-height: 1.6;
      font-weight: 500;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .message-row.bot .bubble {
      background: var(--bot-bubble);
      border-bottom-left-radius: 4px;
      color: #e2e8f0;
      border: 1px solid var(--accent-secondary);
    }

    .message-row.user .bubble {
      background: var(--user-bubble);
      border-bottom-right-radius: 4px;
      color: white;
    }

    .bubble.user {
      padding: 12px 18px;
      max-width: 75%;
      margin-left: auto;
    }

    .bubble.state-success {
      animation: successPulse 0.55s ease-out;
      box-shadow: 0 0 14px rgba(34, 211, 238, 0.35);
      border-color: rgba(34, 211, 238, 0.75);
    }

    .bubble.state-soft-error {
      animation: softHint 0.45s ease-out;
      border-color: rgba(245, 158, 11, 0.7);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.2);
    }

    @keyframes successPulse {
      0% { transform: scale(1); }
      45% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes softHint {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }

    /* Markdown b√°sico simulado */
    .bubble strong { color: var(--accent-secondary); font-weight: 700; }
    .bubble ul { padding-left: 20px; margin: 8px 0; }
    
    /* √Årea de Entrada (Input) */
    .input-area {
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid rgba(255,255,255,0.05);
      position: sticky;
      bottom: 0;
      z-index: 5;
    }

    .suggested-actions {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      padding-bottom: 10px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    .suggested-actions.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .suggested-actions button {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(6, 182, 212, 0.15));
      border: 1px solid rgba(139, 92, 246, 0.35);
      color: var(--text-white);
      border-radius: 999px;
      padding: 10px 12px;
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
      text-align: center;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }

    .suggested-actions button:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(6, 182, 212, 0.25));
      border-color: rgba(139, 92, 246, 0.6);
      transform: translateY(-2px);
    }

    .input-wrapper {
      position: relative;
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: #334155;
      border-radius: 20px;
      padding: 6px;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }

    .input-wrapper:focus-within {
      border-color: var(--accent-secondary);
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-family: 'Nunito', sans-serif;
      font-size: 20px;
      padding: 12px 12px;
      resize: none;
      max-height: 120px;
      outline: none;
      line-height: 1.4;
    }

    textarea::placeholder { color: rgba(255,255,255,0.4); }

    .send-btn {
      background: var(--accent-secondary);
      border: none;
      border-radius: 16px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, background 0.2s ease;
      color: #0f172a;
    }

    .send-btn:hover {
      background: #22d3ee;
      transform: scale(1.1);
    }

    .send-btn:disabled {
      background: #475569;
      cursor: not-allowed;
      transform: none;
    }

    /* Indicador de carga */
    .typing-indicator {
      display: none;
      padding: 15px;
      background: var(--bot-bubble);
      border-radius: 20px;
      border-bottom-left-radius: 4px;
      width: fit-content;
      margin-left: 48px; /* Para alinear con avatar */
      gap: 5px;
    }
    .dot {
      width: 8px; height: 8px;
      background: #94a3b8;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @media (min-width: 1024px) {
      .app-shell {
        max-width: 1200px;
        height: calc(100dvh - 64px);
        margin: 32px auto;
        border-radius: 24px;
        border: 1px solid rgba(255,255,255,0.08);
      }

      .chat-area {
        padding: 20px 16px;
      }

      .message-row {
        width: 100%;
      }

      .input-area {
        padding: 12px 24px 16px;
      }

      .input-wrapper {
        padding: 4px;
      }
    }

    @media (max-width: 720px) {
      .bubble {
        font-size: 16px;
      }

      textarea {
        font-size: 18px;
      }

      .suggested-actions {
        grid-template-columns: 1fr;
      }
    }

    /* Visualizaci√≥n pedag√≥gica premium (Ejemplo Gemelo) */
    .bubble blockquote {
      background: rgba(6, 182, 212, 0.12);
      border-left: 4px solid var(--accent-secondary);
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.95em;
    }

    .bubble strong {
      color: #c084fc;
    }

  </style>
</head>
<body>

<div class="app-shell">
  <header class="top-bar">
    <div class="brand">
      <img class="logo-image" src="holamati.png" alt="Mati" />
      <div class="app-title">MATI</div>
    </div>
    <div class="streak-bar" id="streak">üî• Racha: 0 d√≠as</div>
    <button type="button" class="reset-btn" id="resetBtn">Reiniciar chat</button>
  </header>

  <div class="chat-panel">
    <div class="chat-area" id="messagesEl">
      <div class="message-row bot">
        <div class="avatar bot"><img src="mati.png" alt="Mati" /></div>
        <div class="bubble">
          ¬°Hola! Soy <strong>MATI</strong>, tu Entrenador. üß¢  
          <br>¬øEntrenamos para subir tus notas o revisamos una tarea dif√≠cil? üî•
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="loader">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>

  <div class="input-area">
    <div class="suggested-actions" id="suggestedActions">
      <button type="button">üî• ¬øOtro m√°s dif√≠cil?</button>
      <button type="button">üòï No entend√≠</button>
      <button type="button">üôå ¬°Gracias!</button>
    </div>
    <form class="input-wrapper" id="form">
      <textarea id="input" rows="1" placeholder="Escribe tu problema aqu√≠..." autocomplete="off"></textarea>
      <button type="submit" class="send-btn" id="sendBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </form>
  </div>
</div>

<script>
  // Mantenemos la URL original que el usuario proporcion√≥
  const API_URL = "https://hotel-chat-proxy.vercel.app/api/mati";

  const messagesEl = document.getElementById("messagesEl");
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const loader = document.getElementById("loader");
  const streakEl = document.getElementById("streak");
  const suggestedActions = document.getElementById("suggestedActions");
  const suggestionButtons = Array.from(suggestedActions.querySelectorAll("button"));
  const resetBtn = document.getElementById("resetBtn");

  const welcomeMessage = "¬°Hola! Soy **MATI**, tu Entrenador. üß¢  \n¬øEntrenamos para subir tus notas o revisamos una tarea dif√≠cil? üî•";

  // Historial de mensajes
  let messages = [];
  let isLoading = false;
  let exerciseActive = false;

  function getTodayString() {
    return new Date().toISOString().split("T")[0];
  }

  function getPracticeCount() {
    const stored = parseInt(localStorage.getItem("practiceCount") || "0", 10);
    return Number.isNaN(stored) ? 0 : stored;
  }

  function incPracticeCount() {
    const nextCount = getPracticeCount() + 1;
    localStorage.setItem("practiceCount", String(nextCount));
    return nextCount;
  }

  function getLastPracticeISO() {
    return localStorage.getItem("lastPracticeISO");
  }

  function setLastPracticeISO(value) {
    localStorage.setItem("lastPracticeISO", value);
  }

  function updateStreakDisplay(value) {
    streakEl.textContent = value >= 4
      ? `üî• Racha: ${value} d√≠as ‚Äî ¬°Leyenda! No la pierdas üëë`
      : `üî• Racha: ${value} d√≠as`;
  }

  function initializeStreak() {
    const saved = parseInt(localStorage.getItem("streak") || "0", 10);
    updateStreakDisplay(Number.isNaN(saved) ? 0 : saved);
  }

  function updateStreakOnSend() {
    const today = getTodayString();
    const lastDate = localStorage.getItem("lastPracticeDate");
    let streak = parseInt(localStorage.getItem("streak") || "0", 10);

    if (!lastDate) {
      streak = 1;
    } else if (lastDate === today) {
      updateStreakDisplay(Number.isNaN(streak) ? 0 : streak);
      return;
    } else {
      const diffMs = new Date(today) - new Date(lastDate);
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      streak = diffDays === 1 ? (Number.isNaN(streak) ? 1 : streak + 1) : 1;
    }

    localStorage.setItem("streak", streak);
    localStorage.setItem("lastPracticeDate", today);
    updateStreakDisplay(streak);
  }

  // L√≥gica de UI - Autoajustar altura del textarea
  input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    if(this.value === '') this.style.height = 'auto';
  });

  // Enviar con Enter
  input.addEventListener("keydown", event => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.requestSubmit();
    }
  });

  const suggestionSets = {
    default: [
      { label: "üî• ¬øOtro m√°s dif√≠cil?", send: "Ponme uno m√°s dif√≠cil" },
      { label: "üòï No entend√≠", send: "No entend√≠, expl√≠camelo m√°s lento" },
      { label: "üôå ¬°Gracias!", send: "Gracias MATI üòÑ" }
    ],
    success: [
      { label: "üöÄ S√∫beme el nivel", send: "S√∫beme el nivel, quiero un reto m√°s duro" },
      { label: "‚ö° Reto rel√°mpago", send: "Dame un reto r√°pido y dif√≠cil" },
      { label: "üî• ¬øOtro m√°s dif√≠cil?", send: "Ponme uno m√°s dif√≠cil" }
    ],
    help: [
      { label: "üß≠ Paso a paso", send: "Expl√≠camelo paso a paso, por favor" },
      { label: "üß© Otro ejemplo", send: "Dame un ejemplo similar y resu√©lvelo" },
      { label: "üòï No entend√≠", send: "No entend√≠, expl√≠camelo m√°s lento" }
    ]
  };

  function renderSuggestions(list) {
    suggestionButtons.forEach((button, index) => {
      const item = list[index];
      if (!item) {
        button.style.display = "none";
        return;
      }
      button.style.display = "inline-flex";
      button.textContent = item.label;
      button.dataset.send = item.send;
    });
  }

  function updateSuggestionsByText(text) {
    const normalized = text.toLowerCase();
    const successHints = ["¬°seco!", "¬°crack!", "¬°excelente!", "¬°genial!", "¬°muy bien!"];
    const helpHints = ["no entend√≠", "veamos paso a paso", "paso a paso", "revisemos", "no te preocupes"];

    if (successHints.some(word => normalized.includes(word.replace("¬°", "").replace("!", "")))) {
      renderSuggestions(suggestionSets.success);
      return;
    }

    if (helpHints.some(word => normalized.includes(word))) {
      renderSuggestions(suggestionSets.help);
      return;
    }

    renderSuggestions(suggestionSets.default);
  }

  function setExerciseActive(active) {
    exerciseActive = active;
    suggestedActions.classList.toggle("visible", exerciseActive);
  }

  function isExerciseOrExplanation(text) {
    const normalizeText = (value) =>
      value
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    const normalized = normalizeText(text);
    const includesAny = (list) => list.some((hint) => normalized.includes(normalizeText(hint)));

    const keywordHints = [
      "matematica",
      "matematico",
      "algebra",
      "aritmetica",
      "geometria",
      "trigonometria",
      "estadistica",
      "probabilidad",
      "fraccion",
      "fracciones",
      "decimal",
      "decimales",
      "porcentaje",
      "porcentajes",
      "razon",
      "proporcion",
      "ecuacion",
      "ecuaciones",
      "variable",
      "incognita",
      "funcion",
      "funciones",
      "grafico",
      "sistema de ecuaciones",
      "suma",
      "sumar",
      "resta",
      "restar",
      "multiplicacion",
      "multiplicar",
      "division",
      "dividir",
      "producto",
      "cociente",
      "potencia",
      "potencias",
      "exponente",
      "exponentes",
      "raiz",
      "raiz cuadrada",
      "cuadrado",
      "cubo",
      "valor",
      "resultado",
      "solucion",
      "igualdad",
      "igual",
      "formula",
      "expresion",
      "angulo",
      "angulos",
      "triangulo",
      "rectangulo",
      "circulo",
      "perimetro",
      "area",
      "volumen",
      "base",
      "altura",
      "radio",
      "diametro",
      "ejercicio",
      "ejercicios",
      "problema",
      "problemas",
      "reto",
      "desafio",
      "calcula",
      "calcular",
      "resuelve",
      "resolver",
      "encuentra",
      "determinar",
      "cuanto",
      "paso a paso",
      "veamos",
      "revisemos",
      "primero",
      "luego",
      "despues",
      "porque",
      "por que",
      "ya que",
      "intenta",
      "prueba",
      "quieres intentar",
      "otro numero",
      "ejemplo",
      "ejemplos"
    ];

    const socialHints = [
      "hola",
      "buenas",
      "como estas",
      "como te llamas",
      "tu nombre",
      "cuantos anos tienes",
      "que es mati",
      "soy un bot",
      "soy un asistente",
      "adios",
      "chau",
      "bye",
      "gracias",
      "de nada"
    ];

    const hasKeywords = includesAny(keywordHints);
    const hasDigits = /\d/.test(normalized);
    const hasOperators = /[+\-*/=^‚àö√ó√∑]/.test(text);
    const hasFraction = /\d+\s*\/\s*\d+/.test(normalized);
    const hasPor = /\d+\s*(x|√ó|\*|por)\s*\d+/.test(normalized);
    const hasExponent = /\d+\s*\^\s*\d+/.test(normalized) || /\d+\s*[¬≤¬≥]/.test(text);
    const hasLatex =
      /\\(frac|sqrt|times|div)\b/.test(text) ||
      /\$\$[^$]+\$\$/.test(text) ||
      /\$[^$]+\$/.test(text) ||
      /\\\([^)]*\\\)/.test(text) ||
      /\\\[[^\]]*\\\]/.test(text);

    const hasMathPatterns =
      (hasDigits && hasOperators) || hasFraction || hasPor || hasExponent;
    const hasMathSignals = hasKeywords || hasMathPatterns || hasLatex;

    if (includesAny(socialHints) && !hasMathSignals) {
      return false;
    }

    return hasMathSignals;
  }

  function handleBotMessageState(text) {
    if (isLoading) {
      setExerciseActive(false);
      return;
    }
    setExerciseActive(isExerciseOrExplanation(text));
  }

  function applyBubbleState(bubble, text) {
    const normalized = text.toLowerCase();
    const successKeywords = ["bien", "correcto", "excelente", "lograste", "bien hecho"];
    const errorKeywords = ["casi", "intentemos", "revisemos", "pista"];

    const matchesSuccess = successKeywords.some(word => normalized.includes(word));
    const matchesError = errorKeywords.some(word => normalized.includes(word));

    if (matchesSuccess) {
      bubble.classList.add("state-success");
      setTimeout(() => bubble.classList.remove("state-success"), 650);
      return;
    }

    if (matchesError) {
      bubble.classList.add("state-soft-error");
      setTimeout(() => bubble.classList.remove("state-soft-error"), 600);
    }
  }

  // Funci√≥n para a√±adir mensaje al HTML
  function appendMessage(role, text) {
    const div = document.createElement("div");
    div.className = `message-row ${role}`;
    
    const avatar = document.createElement("div");
    avatar.className = `avatar ${role}`;
    if (role === 'user') {
      avatar.textContent = 'üßë‚Äçüéì';
    } else {
      const botImg = document.createElement("img");
      botImg.src = "mati.png";
      botImg.alt = "Mati";
      avatar.appendChild(botImg);
    }

    const bubble = document.createElement("div");
    bubble.className = role === "user" ? "bubble user" : "bubble";
    
    // TRUCO: Duplicamos las barras invertidas (\\) antes de pasar por Marked.
    // As√≠, Marked consume una barra y deja la otra intacta para que KaTeX la lea.
    const protectedText = text.replace(/\\/g, '\\\\');
    
    bubble.innerHTML = marked.parse(protectedText);

    if (role === 'user') {
      div.appendChild(bubble);
      div.appendChild(avatar);
    } else {
      div.appendChild(avatar);
      div.appendChild(bubble);
    }

    messagesEl.appendChild(div);
    if (role === 'bot' && typeof renderMathInElement === "function") {
      renderMathInElement(bubble, {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$", right: "$", display: false },
          { left: "\\\\[", right: "\\\\]", display: true },
          { left: "\\\\(", right: "\\\\)", display: false }
        ]
      });
    }
    if (role === "bot") {
      handleBotMessageState(text);
      applyBubbleState(bubble, text);
    }
    // Auto-scroll al fondo
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function sendMessage(text, imageData) {
    if (isLoading) return;

    incPracticeCount();
    setLastPracticeISO(new Date().toISOString());

    // UI Updates
    input.value = "";
    input.style.height = "auto";
    setExerciseActive(false);
    appendMessage("user", text);
    updateStreakOnSend();

    setLoading(true);

    messages.push({ role: "user", content: text });

    const payload = {
      messages: messages
    };

    if (imageData) {
      payload.image = imageData;
    }

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error("Error en la conexi√≥n");

      const data = await response.json();
      const answerText = data.message;

      // Limpiar respuesta si viene con formato JSON o markdown excesivo del backend original
      // (Intento de extraer texto limpio si el backend devuelve JSON stringificado)
      let cleanText = answerText;
      try {
        // A veces los proxies devuelven "resultado: ..."
        cleanText = cleanText.replace(/^"/, "").replace(/"$/, "").replace(/\\n/g, "\n");
      } catch(e) {}

      // --- EFECTO DOPAMINA: CONFETTI AL ACIERTO ---
      const successKeywords = ["¬°Seco!", "¬°Crack!", "¬°Excelente!", "¬°Genial!", "¬°Muy bien!"];

      if (successKeywords.some(word => cleanText.includes(word))) {
        confetti({
          particleCount: 150,
          spread: 70,
          origin: { y: 0.6 },
          colors: ['#8b5cf6', '#06b6d4', '#ffffff']
        });
      }

      messages.push({ role: "assistant", content: cleanText });
      appendMessage("bot", cleanText);
      updateSuggestionsByText(cleanText);

    } catch (error) {
      console.error(error);
      appendMessage("bot", "‚ö†Ô∏è Ups, se me ha ca√≠do la calculadora. Int√©ntalo de nuevo.");
      updateSuggestionsByText("no entend√≠");
    } finally {
      setLoading(false);
    }
  }

  suggestionButtons.forEach(button => {
    button.addEventListener("click", () => {
      const payload = button.dataset.send || button.textContent.trim();
      sendMessage(payload);
    });
  });

  resetBtn.addEventListener("click", () => {
    messages = [];
    messagesEl.innerHTML = "";
    appendMessage("bot", welcomeMessage);
    input.value = "";
    input.style.height = "auto";
    updateSuggestionsByText("default");
    setExerciseActive(false);
    setLoading(false);
  });

  // Manejo del env√≠o
  form.addEventListener("submit", async e => {
    e.preventDefault();
    if (isLoading) return;
    
    const text = input.value.trim();
    if (!text) return;

    sendMessage(text);
  });

  function setLoading(active) {
    isLoading = active;
    sendBtn.disabled = active;
    loader.style.display = active ? 'flex' : 'none';
    if (active) {
      setExerciseActive(false);
    }
    if(active) messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  initializeStreak();
  renderSuggestions(suggestionSets.default);
  updateSuggestionsByText("default");
  setExerciseActive(false);
</script>

</body>
</html>
